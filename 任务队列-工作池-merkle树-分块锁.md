# 解决超大文件分块算哈希场景

[TOC]



## 1.极限方案-多线程merkle树原子并发

![IMG_0574.jpeg](https://s2.loli.net/2025/09/27/8eyMn7uPvE6LU9k.jpg)

```js
1.构建marklee树的过程，可以顺便构建双向链表，通过任意节点可以得到兄弟以及父亲
2.其他过程任务队列、工作池、webworker、以及怎么用多线程api略
3.分块锁，
初始化全部无锁，一层一套锁，
第四层h4 2^3 个锁 [ , , , , , , , ]
第三层h3 2^2 个锁 [ , , , ]
第二层h2 2^1 个锁 [ , ]
第一层h1 2^0 个锁 [ ]
H1 和 H2 叶子节点，争抢h4[0],谁争到谁去合并对方，没争到的就作罢
H3 和 H4 叶子节点，争抢h4[1],谁争到谁去合并对方，没争到的就作罢
......
H15 和 H16 叶子节点，争抢h4[7],谁争到谁去合并对方，没争到的就作罢

H1_2 和 H3_4非叶子节点，争抢h3[0],谁争到谁去合并对方，没争到的就作罢
......
H13_14 和 H15_16非叶子节点，争抢h3[3],谁争到谁去合并对方，没争到的就作罢

直到H1_16....

tips:但是会出现并发递减的现象，在剩下的任务数量 < 并发数下，处理哈希合并忽略不计

4.主要考虑的是模型的实现，工程细节略
```



## 2.简单方案-多文件并发，顺序md5

```js
1.任务队列+工作池+webworker，多文件并发计算，
2.单文件计算，依次md5 append
```

## 3.方案选择

```js
带宽、性能、代码维护成本、业务规模综合考量。
IF (前端哈希结果会被后端“直接信任并入库”) THEN
    必须全量哈希
ELSE IF (后端还会读取文件校验) THEN
    可以抽样
ELSE IF (只是做秒传或断点续传标识) THEN
    抽样更优
```

